<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XiaoZhi WebRTC</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background: #ededed;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* 初始页面样式 */
        .initial-page {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #667eea;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            padding: 2rem;
        }

        .initial-page.hidden {
            opacity: 0;
            transform: translateY(-50px);
            pointer-events: none;
        }

        .initial-container {
            max-width: 480px;
            width: 100%;
            position: relative;
        }

        .initial-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .initial-title {
            color: white;
            font-size: 3rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .initial-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            font-weight: 300;
            text-align: center;
        }

        .initial-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .initial-input-section {
            margin-bottom: 2rem;
        }

        .input-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            font-weight: 400;
            text-align: left;
            display: block;
        }

        .initial-input {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .initial-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .initial-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .initial-input.error {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .initial-error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 0.8rem;
            text-align: center;
        }

        /* MAC地址预设标签样式 */
        .mac-preset-section {
            margin-top: 1.5rem;
        }

        .preset-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            font-weight: 400;
            text-align: left;
            display: block;
        }

        .mac-preset-tags {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .mac-preset-tag {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .mac-preset-tag:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .preset-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .preset-name {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .initial-actions {
            margin-top: 1.5rem;
        }

        .initial-control-button {
            background: #5a67d8;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .initial-control-button:hover {
            background: #4c63d2;
            border-color: rgba(255, 255, 255, 0.4);
        }

        .initial-control-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .initial-control-button:disabled:hover {
            background: #5a67d8;
        }

        .button-icon {
            font-size: 1.2rem;
        }

        .button-icon.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .initial-control-button.stop {
            background: #e53e3e;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .initial-control-button.stop:hover {
            background: #c53030;
        }

        /* 主页面样式 */
        .main-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            opacity: 0;
            transform: translateY(100%);
            transition: all 0.5s ease;
        }

        .main-page.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            background: #ededed;
            position: relative;
        }

        .control-button {
            background: #07C160;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #06ae56;
        }

        .control-button.stop {
            background: #f44336;
        }

        .control-button.stop:hover {
            background: #da190b;
        }

        .status {
            font-size: 0.9rem;
            color: #999;
            margin-top: 0.5rem;
        }

        #media {
            width: 100%;
            height: 100vh;
            background: #fff;
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .main-video {
            position: absolute;
            top: 10%;
            left: 20%;
            right: 20%;
            bottom: 18%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .main-video video {
            width: 100%;
            height: 100%;
            background: #000;
            object-fit: cover;
        }

        .small-video {
            position: absolute;
            bottom: calc(18% + 20px);
            left: calc(20% + 20px);
            width: 200px;
            height: 150px;
            background: #000;
            border-radius: 8px;
            border: 3px solid #fff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .small-video:hover {
            transform: scale(1.05);
            border-color: #07C160;
        }

        .small-video video {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 5px;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            z-index: 10;
        }

        /* 视频控制栏样式 */
        .video-controls {
            position: absolute;
            bottom: 6%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 500px;
            height: 60px;
            z-index: 200;
            padding: 0 50px;
        }

        .video-control-btn {
            background: #f5f5f5;
            color: #666;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .video-control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .video-control-btn.close {
            background: rgb(255, 242, 242);
            color: #ff4757;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.1);
            position: relative;
        }

        .video-control-btn.close:hover {
            background: rgb(255, 230, 230);
            color: #ff3742;
        }

        .video-control-btn.close::before {
            content: '关闭';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            z-index: 1000;
        }

        .video-control-btn.close::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0, 0, 0, 0.8);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 2px;
            z-index: 1000;
        }

        .video-control-btn.close:hover::before,
        .video-control-btn.close:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .video-control-btn.video-btn {
            position: relative;
        }

        .video-control-btn.video-btn.active::before {
            content: '关闭摄像头';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            z-index: 1000;
        }

        .video-control-btn.video-btn.inactive::before {
            content: '开启摄像头';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            z-index: 1000;
        }

        .video-control-btn.video-btn::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0, 0, 0, 0.8);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            margin-bottom: 2px;
            z-index: 1000;
        }

        .video-control-btn.video-btn:hover::before,
        .video-control-btn.video-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .video-control-btn.video-btn.active {
            background: rgb(247, 248, 252);
            color: #666;
        }

        .video-control-btn.video-btn.inactive {
            background: rgb(247, 248, 252);
            color: #666;
        }

        .video-control-btn .icon {
            font-size: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-control-btn .icon svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        /* 状态指示器 */
        .status-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 18px;
            border-radius: 25px;
            transition: all 0.4s ease;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 我在说话状态 */
        .status-indicator.speaking {
            color: #06ae56;
        }

        .status-indicator.speaking::before {
            content: '🗣️';
            font-size: 16px;
            animation: speaking-bounce 1s infinite;
        }

        /* 我在听状态 */
        .status-indicator.listening {
            color: #2980b9;
        }

        .status-indicator.listening::before {
            content: '👂';
            font-size: 16px;
            animation: listening-tilt 2s infinite;
        }

        /* 说话弹跳动画 */
        @keyframes speaking-bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* 倾听倾斜动画 */
        @keyframes listening-tilt {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }


        /* 消息气泡容器 */
        .message-bubbles-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
            pointer-events: none;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
        }

        .message-bubbles-container::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari and Opera */
        }

        .message-bubble {
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            line-height: 1.4;
            word-break: break-word;
            max-width: 100%;
            animation: bubbleSlideIn 0.4s ease-out;
            pointer-events: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .message-bubble.user {
            background: rgba(149, 236, 105, 0.95);
            color: #333;
            align-self: flex-end;
            margin-left: 40px;
        }

        .message-bubble.assistant {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            align-self: flex-start;
            margin-right: 40px;
        }

        @keyframes bubbleSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .section-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .initial-title {
                font-size: 2.5rem;
            }

            .initial-subtitle {
                font-size: 1.1rem;
            }

            .mac-preset-tags {
                gap: 0.8rem;
            }

            .mac-preset-tag {
                padding: 0.8rem;
            }

            .preset-name {
                font-size: 0.8rem;
            }

            .main-video {
                left: 5%;
                right: 5%;
            }

            .small-video {
                width: 150px;
                height: 113px;
                /*bottom: calc(6% + 70px);*/
                left: calc(5% + 15px);
            }

            .video-controls {
                width: 350px;
                height: 55px;
                padding: 0 20px;
            }

            .video-control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .video-control-btn.close {
                font-size: 20px;
            }

            .status-indicator {
                font-size: 14px;
                padding: 8px 14px;
                gap: 6px;
            }

            .status-indicator.speaking::before,
            .status-indicator.listening::before {
                font-size: 14px;
            }

            .message-bubbles-container {
                width: 280px;
                bottom: 15px;
                right: 15px;
            }
        }

        @media (max-width: 480px) {
            .initial-page {
                padding: 1.5rem 1rem;
            }

            .initial-title {
                font-size: 2.2rem;
            }

            .initial-subtitle {
                font-size: 1rem;
            }

            .initial-input {
                padding: 0.8rem 1.2rem;
                font-size: 0.95rem;
            }

            .mac-preset-tags {
                gap: 0.6rem;
            }

            .mac-preset-tag {
                padding: 0.6rem;
            }

            .preset-name {
                font-size: 0.75rem;
            }

            .initial-control-button {
                padding: 0.9rem 1.5rem;
                font-size: 1rem;
            }

            .main-video {
                left: 5%;
                right: 5%;
            }

            .small-video {
                width: 120px;
                height: 90px;
                /*bottom: calc(15% + 60px);*/
                left: calc(5% + 10px);
            }

            .video-controls {
                bottom: 6%;
                width: 300px;
                height: 50px;
                padding: 0 15px;
            }

            .video-control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .video-control-btn.close {
                font-size: 18px;
            }

            .video-label {
                font-size: 10px;
                padding: 3px 6px;
            }

            .message-bubbles-container {
                width: 260px;
                bottom: 10px;
                right: 10px;
                max-height: 85%;
            }

            .message-bubble {
                padding: 10px 14px;
                font-size: 13px;
            }

            .status-indicator {
                font-size: 13px;
                padding: 6px 12px;
                gap: 5px;
            }

            .status-indicator.speaking::before,
            .status-indicator.listening::before {
                font-size: 13px;
            }
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- 初始页面 -->
        <div class="initial-page" :class="{ 'hidden': isConnected }">
            <div class="initial-container">
                <div class="initial-header">
                    <div class="initial-title">XiaoZhi WebRTC</div>
                    <div class="initial-subtitle">小智 智能聊天助手</div>
                </div>

                <div class="initial-card">
                    <div class="initial-input-section">
                        <div class="input-label">设备配置</div>
                        <input type="text" class="initial-input" v-model="macAddress" placeholder="请输入你的设备MAC地址（可选）"
                            :class="{ 'error': macAddressError }" @input="validateMacAddress">

                        <div v-if="macAddressError" class="initial-error-message">
                            请输入正确的MAC地址格式 (XX:XX:XX:XX:XX:XX)
                        </div>

                        <!-- MAC地址预设标签 -->
                        <div class="mac-preset-section">
                            <div class="preset-label">快速选择默认设备</div>
                            <div class="mac-preset-tags">
                                <div class="mac-preset-tag" @click="selectPresetMac('00:00:00:00:00:aa')">
                                    <span class="preset-name">💢 情感多变小智</span>
                                </div>
                                <div class="mac-preset-tag" @click="selectPresetMac('00:00:00:00:00:bb')">
                                    <span class="preset-name">🤔 好奇小男孩</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="initial-actions">
                        <button class="initial-control-button" @click="start()" v-if="!isStarted"
                            :disabled="macAddressError">
                            <span class="button-icon">🎯</span>
                            开始通话
                        </button>
                        <button class="initial-control-button stop" @click="stop()" v-if="isStarted">
                            <span class="button-icon spinning">⚡</span>
                            正在连接中 ...
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主页面 -->
        <div class="main-page" :class="{ 'visible': isConnected }">
            <div class="chat-container">
                <div id="media">
                    <div class="video-container">
                        <!-- 主视频 -->
                        <div class="main-video">
                            <div class="video-label">{{ isLocalVideoMain ? '本地视频' : '远程视频' }}</div>
                            <video ref="mainVideo" autoplay :muted="isLocalVideoMain" playsinline></video>
                        </div>

                        <!-- 小视频 -->
                        <div class="small-video" @click="switchVideoPosition">
                            <div class="video-label">{{ isLocalVideoMain ? '远程视频' : '本地视频' }}</div>
                            <video ref="smallVideo" autoplay :muted="!isLocalVideoMain" playsinline></video>
                        </div>

                        <!-- 视频控制栏 -->
                        <div class="video-controls">
                            <!-- 左侧关闭按钮 -->
                            <button class="video-control-btn close" @click="stop" title="结束通话">
                                <span class="icon">✕</span>
                            </button>

                            <!-- 中间状态显示 -->
                            <div class="status-indicator"
                                :class="{ speaking: speakingState === 'speaking', listening: speakingState === 'listening' }">
                                {{ speakingState === 'listening' ? '我在听' : '我在说话' }}
                            </div>

                            <!-- 右侧功能按钮 -->
                            <button class="video-control-btn video-btn"
                                :class="{ 'active': showLocalVideo, 'inactive': !showLocalVideo }"
                                @click="toggleLocalVideo" :title="showLocalVideo ? '关闭本地视频' : '开启本地视频'">
                                <span class="icon" v-if="showLocalVideo">
                                    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M907.712 642.592l-2.624-302.592-204.256 145.056 206.88 157.536z m-39.68-354.784a64 64 0 0 1 101.056 51.648l2.624 302.592a64 64 0 0 1-102.752 51.456l-206.912-157.536a64 64 0 0 1 1.728-103.104l204.256-145.056z"
                                            fill="currentColor"></path>
                                        <path
                                            d="M144 256a32 32 0 0 0-32 32v417.376a32 32 0 0 0 32 32h456.32a32 32 0 0 0 32-32V288a32 32 0 0 0-32-32H144z m0-64h456.32a96 96 0 0 1 96 96v417.376a96 96 0 0 1-96 96H144a96 96 0 0 1-96-96V288a96 96 0 0 1 96-96z"
                                            fill="currentColor"></path>
                                    </svg>
                                </span>
                                <span class="icon" v-else>
                                    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M106.912 152.096A32 32 0 1 1 149.12 103.904l768 672a32 32 0 0 1-42.176 48.192l-768-672z"
                                            fill="currentColor"></path>
                                        <path
                                            d="M732.672 462.4l-37.056-52.16 172.416-122.432a64 64 0 0 1 101.056 51.648l2.624 302.592a63.904 63.904 0 0 1-20.16 47.2l-43.84-46.656-2.624-302.592-172.416 122.432z m-34.72-54.016l35.616 53.184c-10.752 7.2-24.32 12.16-37.216 12.16a64 64 0 0 1-64-64V288a32 32 0 0 0-32-32h-205.952V192h205.952a96 96 0 0 1 96 96v121.28c0.416-0.224 1.088-0.544 1.6-0.896zM632.32 608h64v97.376a96 96 0 0 1-96 96H144a96 96 0 0 1-96-96V288a96 96 0 0 1 96-96h96v64h-96a32 32 0 0 0-32 32v417.376a32 32 0 0 0 32 32h456.32a32 32 0 0 0 32-32V608z"
                                            fill="currentColor"></path>
                                    </svg>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 消息气泡容器 -->
            <div class="message-bubbles-container">
                <div v-for="(message, index) in displayMessages" :key="index"
                    :class="['message-bubble', message.role === 'user' ? 'user' : 'assistant']">
                    {{ message.content }}
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                pc: null,
                localStream: null,
                remoteStream: null, // 存储远程视频流
                isStarted: false,
                isConnected: false,
                status: null,
                dataChannel: null,
                messages: [],
                open_xiaozhi_url: true,
                maxMessages: 20, // 最大显示消息数量
                macAddress: '',
                macAddressError: false,
                isLocalVideoMain: false, // 控制哪个视频是主视频，默认远程视频为主
                showLocalVideo: false, // 控制本地视频是否显示
                speakingState: 'listening', // 控制状态：'listening' 我在听, 'speaking' 我在说
                currentAudio: null, // 当前正在播放的音频对象
            },
            mounted() {
                this.initializeMedia();
            },
            computed: {
                displayMessages() {
                    // 只显示最新的消息，限制数量
                    return this.messages.slice(-this.maxMessages);
                },
                isMacAddressValid() {
                    // MAC地址可以为空，为空时视为有效
                    if (!this.macAddress) return true;
                    const macAddressPattern = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
                    return macAddressPattern.test(this.macAddress);
                }
            },
            methods: {
                async initializeMedia() {
                    try {
                        this.localStream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                width: 640,
                                height: 480
                            },
                            audio: true,
                        });
                    } catch (error) {
                        console.error('Error accessing media devices:', error);
                    }
                },

                scrollToBottom() {
                    // 滚动到消息容器底部
                    this.$nextTick(() => {
                        const container = document.querySelector('.message-bubbles-container');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },

                async negotiate() {
                    try {
                        // 检查pc是否还存在
                        if (!this.pc) {
                            console.log('PC is null, negotiation cancelled');
                            return;
                        }

                        const offer = await this.pc.createOffer();

                        // 再次检查pc状态
                        if (!this.pc) {
                            console.log('PC became null during offer creation, negotiation cancelled');
                            return;
                        }

                        await this.pc.setLocalDescription(offer);

                        // Wait for ICE gathering to complete
                        await new Promise(resolve => {
                            if (!this.pc) {
                                console.log('PC is null during ICE gathering, negotiation cancelled');
                                resolve();
                                return;
                            }

                            if (this.pc.iceGatheringState === 'complete') {
                                resolve();
                            } else {
                                const checkState = () => {
                                    if (!this.pc) {
                                        console.log('PC became null during ICE gathering, negotiation cancelled');
                                        resolve();
                                        return;
                                    }

                                    if (this.pc.iceGatheringState === 'complete') {
                                        this.pc.removeEventListener('icegatheringstatechange', checkState);
                                        resolve();
                                    }
                                };
                                this.pc.addEventListener('icegatheringstatechange', checkState);
                            }
                        });

                        // 检查pc是否还存在
                        if (!this.pc) {
                            console.log('PC is null before API call, negotiation cancelled');
                            return;
                        }

                        const response = await fetch('/api/offer', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                sdp: this.pc.localDescription.sdp,
                                type: this.pc.localDescription.type,
                                macAddress: this.macAddress,
                            })
                        });

                        const answer = await response.json();

                        // 最终检查pc状态
                        if (!this.pc) {
                            console.log('PC is null before setRemoteDescription, negotiation cancelled');
                            return;
                        }

                        await this.pc.setRemoteDescription(answer);
                    } catch (error) {
                        // 如果是由于pc为null导致的错误，不显示错误提示
                        if (error.message.includes('Cannot read properties of null')) {
                            console.log('Negotiation cancelled due to PC being null');
                            return;
                        }
                        console.error('Error during negotiation:', error);
                        alert('Error during negotiation: ' + error.message);
                    }
                },

                // 接收服务端信息 todo
                setupDataChannel() {
                    // Create a data channel for text messages
                    this.dataChannel = this.pc.createDataChannel('chat');

                    this.dataChannel.onopen = () => {
                        console.log('Data channel is open');
                        // You can send messages to the server if needed
                        // this.dataChannel.send('Hello from client');
                    };

                    this.dataChannel.onmessage = (event) => {
                        console.log('Received message:', typeof event.data);
                        this.messages.push(event.data);

                        this.$nextTick(() => {
                            this.scrollToBottom();
                        });
                    };

                    this.dataChannel.onclose = () => {
                        console.log('Data channel closed');
                    };

                    // Handle server-initiated data channels
                    this.pc.ondatachannel = (event) => {
                        const channel = event.channel;
                        console.log('Data channel from server:', channel.label);

                        channel.onmessage = (e) => {
                            console.log('Received message from server channel:', e.data);
                            const data = JSON.parse(e.data);
                            if (data["type"] == "tts" && data["state"] == "sentence_start") {
                                this.speakingState = "speaking";
                            } else {
                                this.speakingState = "listening";
                            }

                            if (data["type"] === "music") {
                                console.log("data", data["text"]);
                                // data["text"] 是 mp3 url 
                                this.playMusicUrl(data["url"]);
                            }

                            if (data["type"] === "ws" && data["state"] === "close") {
                                this.dataChannel.close();
                                this.pc.close();
                                this.stop();
                                return
                            }

                            if (data["type"] === "stt") {
                                this.messages.push({ "role": "user", "content": data["text"] });
                            } else if (data["type"] === "tts" && data["state"] === "sentence_start") {
                                this.messages.push({ "role": "assistant", "content": data["text"] });
                                if (data["text"].includes("请登录到控制面板添加设备，输入验证码：") && this.open_xiaozhi_url) {
                                    window.open("https://xiaozhi.me/console", "_blank");
                                    this.open_xiaozhi_url = false
                                }
                            } else if (data["type"] === "tool") {
                                if (data["text"] === "set_volume") {
                                    // Normalize volume to be between 0 and 1
                                    // 设置远程视频的音量
                                    if (this.isLocalVideoMain && this.$refs.smallVideo) {
                                        this.$refs.smallVideo.volume = Math.max(0, Math.min(1, data["value"] / 100));
                                    } else if (!this.isLocalVideoMain && this.$refs.mainVideo) {
                                        this.$refs.mainVideo.volume = Math.max(0, Math.min(1, data["value"] / 100));
                                    }
                                } else if (data["text"] === "open_tab") {
                                    window.open(data["value"], "_blank");
                                }
                            }

                            // 确保在添加消息后滚动到底部
                            this.$nextTick(() => {
                                this.scrollToBottom();
                            });

                        };
                    };
                },

                start() {
                    // 如果已经有连接，先停止
                    if (this.pc) {
                        this.stop();
                    }

                    this.pc = new RTCPeerConnection(null);
                    this.status = "connecting...";

                    // Setup data channel for text messages
                    this.setupDataChannel();

                    // Add audio tracks
                    this.localStream.getAudioTracks().forEach(track => {
                        this.pc.addTrack(track, this.localStream);
                    });

                    this.localStream.getVideoTracks().forEach(track => {
                        this.pc.addTrack(track, this.localStream);
                    });

                    // Handle incoming tracks
                    this.pc.addEventListener('track', (evt) => {
                        console.log('Received track:', evt.track.kind);
                        this.remoteStream = evt.streams[0];
                        // 重新分配视频流
                        this.$nextTick(() => {
                            this.assignVideoStreams();
                        });
                    });

                    // Add connection state change listener
                    this.pc.addEventListener('connectionstatechange', () => {
                        console.log('Connection state:', this.pc.connectionState);
                        this.status = this.pc.connectionState;

                        if (this.pc.connectionState === 'connected') {
                            console.log('WebRTC connection established successfully!');
                            this.isConnected = true; // 连接成功，切换到主页面

                            // 等待DOM更新后分配视频流
                            this.$nextTick(() => {
                                this.assignVideoStreams();
                            });
                        }
                    });

                    this.isStarted = true;
                    this.negotiate();
                },

                stop() {
                    this.isStarted = false;
                    this.isConnected = false; // 重置连接状态，回到初始页面
                    // this.messages = [];
                    this.status = null;

                    // 清理视频流
                    if (this.$refs.mainVideo) {
                        this.$refs.mainVideo.srcObject = null;
                    }
                    if (this.$refs.smallVideo) {
                        this.$refs.smallVideo.srcObject = null;
                    }

                    // 重置远程视频流
                    this.remoteStream = null;

                    // 立即清理数据通道
                    if (this.dataChannel) {
                        this.dataChannel.close();
                        this.dataChannel = null;
                    }

                    // 立即清理PeerConnection
                    if (this.pc) {
                        this.pc.close();
                        this.pc = null;
                    }
                },

                validateMacAddress() {
                    // 自动格式化MAC地址
                    this.formatMacAddress();
                    // 验证格式
                    this.macAddressError = this.macAddress && !this.isMacAddressValid;
                },

                formatMacAddress() {
                    // 移除所有非十六进制字符
                    let cleaned = this.macAddress.replace(/[^0-9A-Fa-f]/g, '');

                    // 限制最大长度为12个字符
                    if (cleaned.length > 12) {
                        cleaned = cleaned.substring(0, 12);
                    }

                    // 每两个字符添加冒号
                    let formatted = '';
                    for (let i = 0; i < cleaned.length; i += 2) {
                        if (i > 0) formatted += ':';
                        formatted += cleaned.substring(i, i + 2);
                    }

                    this.macAddress = formatted.toUpperCase();
                },

                selectPresetMac(mac) {
                    this.macAddress = mac;
                    this.validateMacAddress();
                },

                switchVideoPosition() {
                    this.isLocalVideoMain = !this.isLocalVideoMain;
                    // 重新分配视频流
                    this.$nextTick(() => {
                        this.assignVideoStreams();
                    });
                },

                toggleLocalVideo() {
                    this.showLocalVideo = !this.showLocalVideo;
                    // 重新分配视频流
                    this.$nextTick(() => {
                        this.assignVideoStreams();
                    });
                },



                assignVideoStreams() {
                    const mainVideo = this.$refs.mainVideo;
                    const smallVideo = this.$refs.smallVideo;

                    if (!mainVideo || !smallVideo) {
                        console.log('Video elements not ready yet');
                        return;
                    }

                    // 如果不显示本地视频，只显示远程视频在主位置
                    if (!this.showLocalVideo) {
                        if (this.remoteStream) {
                            mainVideo.srcObject = this.remoteStream;
                            mainVideo.style.transform = 'none';
                        }
                        // 隐藏小视频
                        smallVideo.srcObject = null;
                        smallVideo.style.display = 'none';
                        return;
                    }

                    // 显示小视频元素
                    smallVideo.style.display = 'block';

                    if (this.isLocalVideoMain) {
                        // 本地视频在主位置，远程视频在小位置
                        if (this.localStream) {
                            mainVideo.srcObject = this.localStream;
                            mainVideo.style.transform = 'scaleX(-1)'; // 镜像本地视频
                        }
                        if (this.remoteStream) {
                            smallVideo.srcObject = this.remoteStream;
                            smallVideo.style.transform = 'none';
                        }
                    } else {
                        // 远程视频在主位置，本地视频在小位置
                        if (this.remoteStream) {
                            mainVideo.srcObject = this.remoteStream;
                            mainVideo.style.transform = 'none';
                        }
                        if (this.localStream) {
                            smallVideo.srcObject = this.localStream;
                            smallVideo.style.transform = 'scaleX(-1)'; // 镜像本地视频
                        }
                    }
                },

                playMusicUrl(url) {
                    try {
                        // 停止当前正在播放的音频
                        if (this.currentAudio) {
                            this.currentAudio.pause();
                            this.currentAudio.currentTime = 0; // 重置播放位置
                            this.currentAudio = null;
                            console.log('Stopped previous audio');
                        }

                        // 创建 Audio 对象播放音乐
                        const audio = new Audio(url);
                        audio.crossOrigin = 'anonymous'; // 处理跨域问题
                        audio.volume = 0.8; // 设置音量为80%

                        // 设置为当前播放的音频
                        this.currentAudio = audio;

                        // 播放音频
                        audio.play().then(() => {
                            console.log('Music started playing:', url);
                        }).catch(error => {
                            console.error('Error playing music:', error);
                            // 播放失败时清空当前音频引用
                            if (this.currentAudio === audio) {
                                this.currentAudio = null;
                            }
                        });

                        // 监听播放结束事件
                        audio.addEventListener('ended', () => {
                            console.log('Music playback ended');
                            // 播放结束后清空当前音频引用
                            if (this.currentAudio === audio) {
                                this.currentAudio = null;
                            }
                        });

                        // 监听播放错误事件
                        audio.addEventListener('error', (e) => {
                            console.error('Audio playback error:', e);
                            // 播放错误时清空当前音频引用
                            if (this.currentAudio === audio) {
                                this.currentAudio = null;
                            }
                        });

                    } catch (error) {
                        console.error('Error creating audio:', error);
                    }
                }
            }
        });
    </script>
</body>

</html>